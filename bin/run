#!/bin/bash

function help {
  echo "Execute an Ansible script as the current user or superuser"
  echo "Usage: $(basename $0) options script"
  echo "Where: "
  echo "  options can include:"
  echo "    -d causes the script to be dry run"
  echo "    -s causes the script to be run as superuser"
  echo "    -t enables trace output"
  echo "    -v increments verbose output (can be specified up to 3 times)"
  echo "  script is one of bootstrap, playenv or deploy"
  exit -1
}

# Make the root directory of this project current
DIR="$( cd "$( dirname "${bash_source[0]}" )" && pwd )"
cd $DIR

verbose=""
while getopts "dhstv?" opt; do
  case $opt in
    d ) DRYRUN="--check" ;;
    h ) help ;;
    s ) SUDO="--sudo" ;;
    t ) TRACE="set -xv" ;;
    v ) verbose="-v $verbose" ;;
    \?) help ;;
  esac
done
shift $(($OPTIND-1))

if [ -z "$1" ]; then help; fi

if [ "$verbose" ]; then
  echo "Running from $(pwd)"
fi

if [ -f bin/custom ]; then
  source bin/custom
else
  echo "Error: bin/custom does not exist. Create it by typing the following:"
  echo "cp bin/custom{.sample,}"
  echo ""
  echo "After creating it, edit bin/custom as required, then run this command again"
  exit -2
fi

$TRACE
ansible-playbook $DRYRUN $verbose -i hosts.ini yaml/$1.yaml -u ubuntu $SUDO
